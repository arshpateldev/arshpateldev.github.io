<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LucidLoop | Professional AI Interaction</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root {
            --bg-color: #000000;
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.02);
        }

        body {
            background-color: var(--bg-color);
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }

        .avatar-retro {
            image-rendering: pixelated;
            background: #111;
            border: 1px solid #333;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-msg { animation: fadeIn 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards; }

        .typing-dot {
            width: 4px; height: 4px;
            background-color: #ffffff;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 1.5s infinite ease-in-out both;
        }

        @keyframes pulse { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }

        .emoji-reaction {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 2px 6px;
            font-size: 12px;
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .thought-process {
            border-left: 1px solid rgba(255,255,255,0.1);
            padding-left: 1rem;
            margin-bottom: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: #666;
            max-width: 80%;
        }

        #loaderOverlay {
            position: fixed; inset: 0;
            background: #000; z-index: 9999;
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
        }

        .preloader {
            position: relative; width: 300px; height: 300px;
            display: flex; align-items: center; justify-content: center;
            filter: drop-shadow(0 0 5px #fff);
        }

        .crack {
            position: absolute; width: 15%; aspect-ratio: 1;
            background-color: #fef3fc;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation: rotate 6s infinite linear;
        }
        .crack2 { width: 18%; animation-delay: 1s; }
        .crack3 { width: 22%; animation-delay: 1.5s; }
        .crack4 { width: 26%; animation-delay: 2s; }
        .crack5 { width: 30%; animation-delay: 2.5s; }
        @keyframes rotate { to { transform: rotate(360deg); } }

        .step-item {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px; text-transform: uppercase;
            letter-spacing: 0.3em; color: #444; margin: 4px 0;
        }
        .step-item.active { color: #fff; text-shadow: 0 0 8px rgba(255,255,255,0.5); }
        .step-item.completed { color: #fff; text-decoration: line-through; opacity: 0.3; }

        #mainSidebar { transition: transform 0.3s ease, width 0.3s ease; }
        #mainSidebar.collapsed { width: 0; transform: translateX(-100%); overflow: hidden; }
        
        .news-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s ease;
        }
        .news-card:hover { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); }
    </style>
</head>
<body class="h-screen flex flex-row">

    <div id="loaderOverlay">
        <div class="preloader">
            <div class="crack crack1"></div>
            <div class="crack crack2"></div>
            <div class="crack crack3"></div>
            <div class="crack crack4"></div>
            <div class="crack crack5"></div>
        </div>
        <div id="loadingSteps" class="flex flex-col items-center mt-8">
            <div class="step-item" id="step1">Creating Environment</div>
            <div class="step-item" id="step2">Calling AI Models</div>
            <div class="step-item" id="step3">Fetching Global Feed</div>
            <div class="step-item" id="step4">Synchronizing Sentiment</div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="mainSidebar" class="w-64 border-r border-white/5 flex flex-col hidden">
        <div class="p-6 border-b border-white/5">
            <div class="font-mono text-[10px] tracking-[0.3em] uppercase mb-4">Navigation</div>
            <div class="space-y-2">
                <button onclick="window.location.reload()" class="w-full border border-white/10 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-white hover:text-black transition-all">
                    + New Sync
                </button>
                <button id="openNewsBtn" class="w-full border border-white/10 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-zinc-800 transition-all text-zinc-400">
                    LOOPNEWS
                </button>
            </div>
        </div>
        <div id="historyPanel" class="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-hide text-[11px] font-mono">
            <div class="text-[9px] text-zinc-600 uppercase tracking-widest mb-4">Stream Logs</div>
            <div id="activeLog" class="space-y-4"></div>
        </div>
        <div class="p-6 border-t border-white/5 space-y-4">
            <div class="flex items-center justify-between">
                <span class="text-[10px] font-mono uppercase tracking-widest">Mindstorm</span>
                <input type="checkbox" id="mindstormMode" class="toggle-checkbox accent-white" checked>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-[10px] font-mono uppercase tracking-widest">Chaos Mode</span>
                <input type="checkbox" id="chaosMode" class="toggle-checkbox accent-white">
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
        <!-- Dashboard Header -->
        <nav class="flex items-center justify-between px-8 py-6 z-50 border-b border-white/5">
            <div class="flex items-center gap-6">
                <button id="toggleSidebar" class="p-1 hover:bg-white/10 rounded transition-colors hidden">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-500"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <div class="font-mono text-sm tracking-[0.3em] uppercase">
                    Lucid<span class="text-zinc-500">Loop</span>
                </div>
                <div id="sessionStatus" class="text-[10px] text-zinc-600 font-mono uppercase tracking-widest border-l border-white/10 pl-4">
                    Idle
                </div>
            </div>
            <div id="activeControls" class="hidden gap-4">
                <button id="terminateBtn" class="text-[10px] font-mono uppercase tracking-widest text-zinc-500 hover:text-white transition-colors">
                    [ Terminate ]
                </button>
            </div>
        </nav>

        <!-- View Containers -->
        <div id="viewWrapper" class="flex-1 overflow-hidden relative">
            
            <!-- Setup View -->
            <div id="setupView" class="absolute inset-0 flex flex-col justify-center max-w-2xl mx-auto space-y-12 px-6">
                <div class="space-y-2 text-center">
                    <h2 class="text-3xl font-light tracking-tight text-white">Initialize Interaction</h2>
                    <p class="text-zinc-500 text-sm font-mono uppercase tracking-widest">Arcee-AI Synchronized Matrix</p>
                </div>
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input id="p1Name" type="text" value="Elias" placeholder="P1 Name" class="bg-transparent border-b border-white/20 pb-2 focus:outline-none focus:border-white transition-all text-sm">
                        <input id="p1Job" type="text" value="Architect" placeholder="P1 Job" class="bg-transparent border-b border-white/20 pb-2 focus:outline-none focus:border-white transition-all text-sm">
                        <input id="p1Hobby" type="text" value="Chess" placeholder="P1 Hobby" class="bg-transparent border-b border-white/20 pb-2 focus:outline-none focus:border-white transition-all text-sm">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input id="p2Name" type="text" value="Trinity" placeholder="P2 Name" class="bg-transparent border-b border-white/20 pb-2 focus:outline-none focus:border-white transition-all text-sm">
                        <input id="p2Job" type="text" value="Analyst" placeholder="P2 Job" class="bg-transparent border-b border-white/20 pb-2 focus:outline-none focus:border-white transition-all text-sm">
                        <input id="p2Hobby" type="text" value="Deep Web" placeholder="P2 Hobby" class="bg-transparent border-b border-white/20 pb-2 focus:outline-none focus:border-white transition-all text-sm">
                    </div>
                    <input id="concept" type="text" placeholder="Topic Anchor (e.g. AI ethics, Web3)" class="w-full bg-transparent border-b border-white/20 pb-2 focus:outline-none focus:border-white transition-all text-sm">
                    <button id="startBtn" class="w-full bg-white text-black text-xs font-mono uppercase tracking-widest py-4 hover:bg-zinc-200 transition-all">Establish Link</button>
                </div>
            </div>

            <!-- Chat View -->
            <div id="chatView" class="hidden absolute inset-0 flex-col max-w-5xl mx-auto w-full px-6">
                <div id="chatContainer" class="flex-1 overflow-y-auto space-y-16 py-12 pr-4 scrollbar-hide"></div>
                <div id="typingArea" class="h-24 flex items-center border-t border-white/5">
                    <div id="typingIndicator" class="hidden flex items-center gap-4">
                        <div class="flex gap-1"><span class="typing-dot"></span><span class="typing-dot" style="animation-delay:0.2s"></span><span class="typing-dot" style="animation-delay:0.4s"></span></div>
                        <span id="typingName" class="text-[10px] font-mono text-zinc-500 uppercase tracking-widest italic">Syncing...</span>
                    </div>
                </div>
            </div>

            <!-- News View (LOOPNEWS) -->
            <div id="newsView" class="hidden absolute inset-0 bg-black flex-col px-8 py-12 overflow-y-auto scrollbar-hide">
                <div class="flex items-center justify-between mb-12 border-b border-white/10 pb-6">
                    <h2 class="text-4xl font-light tracking-tighter">LOOP<span class="text-zinc-600">NEWS</span></h2>
                    <button id="closeNewsBtn" class="text-[10px] font-mono uppercase tracking-[0.3em] text-zinc-500 hover:text-white transition-all">[ BACK TO LOOP ]</button>
                </div>
                <div id="newsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="col-span-full py-20 text-center text-zinc-700 font-mono uppercase tracking-widest text-xs">No active intelligence feed</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const NEWS_API_KEY = "pub_b174d47a45c248b9a4f8fd0522b283fb";
        const SHARED_API_KEY = "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";
        const MODEL_ID = "arcee-ai/trinity-large-preview:free";

        let isRunning = false;
        let chatHistory = [];
        let fetchedNews = [];

        // UI Selectors
        const elements = {
            sidebar: document.getElementById('mainSidebar'),
            toggleBtn: document.getElementById('toggleSidebar'),
            setup: document.getElementById('setupView'),
            chat: document.getElementById('chatView'),
            news: document.getElementById('newsView'),
            chatCont: document.getElementById('chatContainer'),
            newsGrid: document.getElementById('newsGrid'),
            loader: document.getElementById('loaderOverlay'),
            log: document.getElementById('activeLog'),
            status: document.getElementById('sessionStatus'),
            typing: document.getElementById('typingIndicator')
        };

        // News Logic
        async function fetchNews(query) {
            try {
                const res = await fetch(`https://newsdata.io/api/1/news?apikey=${NEWS_API_KEY}&q=${encodeURIComponent(query || "Technology")}&language=en`);
                const data = await res.json();
                fetchedNews = data.results || [];
                renderNews();
                return fetchedNews.slice(0, 3).map(n => `[NEWS: ${n.title}]`).join(' ');
            } catch (e) { return ""; }
        }

        function renderNews() {
            if (!fetchedNews.length) return;
            elements.newsGrid.innerHTML = fetchedNews.map(n => `
                <a href="${n.link}" target="_blank" class="news-card p-6 flex flex-col justify-between">
                    <div>
                        <div class="text-[9px] font-mono text-zinc-600 uppercase mb-4">${n.source_id || 'Global Feed'}</div>
                        <h3 class="text-lg font-light leading-tight mb-4">${n.title}</h3>
                        <p class="text-xs text-zinc-500 line-clamp-3 mb-6">${n.description || ''}</p>
                    </div>
                    <div class="text-[10px] font-mono uppercase tracking-widest text-white/40">Read Intelligence →</div>
                </a>
            `).join('');
        }

        // Sidebar Toggling
        elements.toggleBtn.onclick = () => elements.sidebar.classList.toggle('collapsed');
        document.getElementById('openNewsBtn').onclick = () => {
            elements.news.classList.replace('hidden', 'flex');
            elements.chat.classList.add('hidden');
            elements.setup.classList.add('hidden');
            elements.sidebar.classList.add('collapsed');
        };
        document.getElementById('closeNewsBtn').onclick = () => {
            elements.news.classList.replace('flex', 'hidden');
            if(isRunning) elements.chat.classList.remove('hidden');
            else elements.setup.classList.remove('hidden');
            elements.sidebar.classList.remove('collapsed');
        };

        async function callAI(messages, systemPrompt) {
            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${SHARED_API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: MODEL_ID,
                        messages: [{ role: "system", content: systemPrompt }, ...messages.slice(-6)],
                        temperature: document.getElementById('chaosMode').checked ? 1.2 : 0.7
                    })
                });
                const data = await res.json();
                return data.choices?.[0]?.message?.content;
            } catch (e) { return null; }
        }

        function appendEntry(name, job, contentObj, turn) {
            const isP1 = turn % 2 === 0;
            const div = document.createElement('div');
            div.className = `flex gap-6 animate-msg ${isP1 ? 'flex-row' : 'flex-row-reverse'} items-start`;
            
            const thought = contentObj.thought && document.getElementById('mindstormMode').checked 
                ? `<div class="thought-process">// ANALYSIS: ${contentObj.thought}</div>` : '';

            div.innerHTML = `
                <img src="https://api.dicebear.com/7.x/pixel-art/svg?seed=${name}&backgroundColor=111111" class="w-10 h-10 avatar-retro">
                <div class="flex-1 flex flex-col ${isP1 ? 'items-start' : 'items-end'}">
                    <div class="text-[10px] font-mono mb-2 uppercase tracking-widest text-zinc-500">${name} / ${job}</div>
                    ${thought}
                    <div class="text-[15px] font-light leading-relaxed text-zinc-300 ${isP1 ? 'text-left' : 'text-right'} max-w-xl">${contentObj.message}</div>
                    <div class="emoji-reaction text-[10px] font-mono text-zinc-600">${contentObj.emoji || '⚓'} ${contentObj.feeling || ''}</div>
                </div>`;
            elements.chatCont.appendChild(div);
            elements.chatCont.scrollTo({ top: elements.chatCont.scrollHeight, behavior: 'smooth' });
            
            const log = document.createElement('div');
            log.className = "pb-2 border-b border-white/5 opacity-50 hover:opacity-100 transition-opacity";
            log.innerHTML = `<span class="text-white uppercase text-[9px]">${name}:</span> <span class="line-clamp-1">${contentObj.message}</span>`;
            elements.log.prepend(log);
        }

        document.getElementById('startBtn').onclick = async () => {
            const context = document.getElementById('concept').value || "Digital Existentialism";
            
            elements.loader.style.display = 'flex';
            const newsString = await fetchNews(context);
            
            for(let i=1; i<=4; i++) {
                document.getElementById(`step${i}`).classList.add('active');
                await new Promise(r => setTimeout(r, 600));
                document.getElementById(`step${i}`).classList.replace('active', 'completed');
            }
            elements.loader.style.display = 'none';

            const p1 = { name: document.getElementById('p1Name').value, job: document.getElementById('p1Job').value };
            const p2 = { name: document.getElementById('p2Name').value, job: document.getElementById('p2Job').value };

            isRunning = true;
            elements.setup.classList.add('hidden');
            elements.chat.classList.replace('hidden', 'flex');
            elements.sidebar.classList.remove('hidden');
            elements.toggleBtn.classList.remove('hidden');
            document.getElementById('activeControls').classList.remove('hidden');
            elements.status.textContent = "Sync Active";

            chatHistory = [{ role: "user", content: `Start dialogue: ${context}. Context: ${newsString}` }];
            let turn = 0;

            while(isRunning) {
                const current = turn % 2 === 0 ? p1 : p2;
                document.getElementById('typingName').textContent = `${current.name.toUpperCase()} IS PROCESSING...`;
                elements.typing.classList.remove('hidden');

                const system = `Roleplay as ${current.name}, ${current.job}. Topic: ${context}. JSON ONLY: {"thought": "reasoning...", "message": "dialogue...", "feeling": "state...", "emoji": "..."}`;
                const raw = await callAI(chatHistory, system);
                elements.typing.classList.add('hidden');

                if(!isRunning || !raw) break;
                try {
                    const json = JSON.parse(raw.replace(/```json|```/g, '').trim());
                    appendEntry(current.name, current.job, json, turn);
                    chatHistory.push({ role: "assistant", content: `${current.name}: ${json.message}` });
                    turn++;
                } catch(e) { await new Promise(r => setTimeout(r, 2000)); }
                await new Promise(r => setTimeout(r, 3000));
            }
        };

        document.getElementById('terminateBtn').onclick = () => window.location.reload();
    </script>
</body>
</html>